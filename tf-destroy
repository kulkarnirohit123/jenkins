pipeline {

  agent any

  /*
    Expected Jenkins variables: 
    environment: Environment name
    region: AWS Region
    bucket: S3 Bucket name to hold terraform state file
  */
  environment {
    project = "<Project-Name>"
    s3_key = "${project}/${environment}/${project}-${environment}.tfstat"
    project_dir = "<location where main.tf is located>"
    tf_plan_file = ".terraform/latest-plan"
    tf_override_vars = ""
    tf_vars_file = "${environment}.tfvars"
    tf_command = "terraform"
  }

  stages {

    stage('TF clean') {
      steps {
        dir(project_dir) {
          sh 'rm -rf .terraform'
        }
      }      
    }

    stage('TF Init') {
      steps {
        dir(project_dir) {
          sh '${tf_command} init \
            -backend-config="bucket=${bucket}" \
            -backend-config="key=${s3_key}" \
            -backend-config="region=${region}" \
            -backend=true \
            -force-copy \
            -get=true \
            -input=false'
        }
      }      
    }

    stage('TF Plan') {
      steps {
        dir(project_dir) {
          sh '${tf_command} plan -no-color -destroy -var-file="${tf_vars_file}" ${tf_override_vars} -out ${tf_plan_file}'
        }
      }
    }

    stage('Approval') {
      steps {
        script {
          def userInput = input(id: 'confirm', message: 'Are you sure you want to destroy all resources?', parameters: [ [$class: 'BooleanParameterDefinition', defaultValue: false, description: 'Apply terraform destroy', name: 'confirm'] ])
        }
      }
    }

    stage('TF Destroy') {
      steps {
        dir(project_dir) {
          sh '${tf_command} destroy -var-file="${tf_vars_file}" ${tf_override_vars} -auto-approve'
        }
      }
    }

  } 

}
